<!DOCTYPE html>
<html>
<head>
    <title>SENDER</title>
    <style>
        #messageList {
            width: 100%;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 10px;
        }
        #chat-message-input {
            width: 80%;
        }
        button {
            width: 15%;
        }
    </style>
    <script>
        const handler = {
            set(target, property, value) {
                console.log(`Array changed at index ${property}: ${target[property]} -> ${value}`);
                target[property] = value;
                renderMessages();
                return true; // Indicate success
            }
        };

        const history = new Proxy([], handler);

        function sendMessage() {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            // Send a POST request to the server
            fetch('/server/queue/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({'message': message})
            }).then(response => {
                if (response.ok) {
                    messageInputDom.value = '';  // Clear input after sending
                    history.push([message, true]);
                } else {
                    history.push([message, false]);
                }
            }).catch(error => {
                console.error('Fetch error:', error);
            });
        }

        Date.prototype.today = function () {
            return ((this.getDate() < 10)?"0":"") + this.getDate() +"/"+(((this.getMonth()+1) < 10)?"0":"") + (this.getMonth()+1) +"/"+ this.getFullYear();
        }

        // For the time now
        Date.prototype.timeNow = function () {
            return ((this.getHours() < 10)?"0":"") + this.getHours() +":"+ ((this.getMinutes() < 10)?"0":"") + this.getMinutes() +":"+ ((this.getSeconds() < 10)?"0":"") + this.getSeconds();
        }

        document.getElementById("addButton").addEventListener("click", () => {
            const inputValue = document.getElementById("arrayInput").value;
            if (inputValue.trim()) { // Only add if there's input
                history.push(inputValue);
                document.getElementById("arrayInput").value = ""; // Clear input
            }
        });

        function renderMessages() {
            const messageList = document.getElementById("messageList");
            messageList.innerHTML = ""; // Clear existing list items
            console.log("SENT")
            var newDate = new Date();
            var datetime = "Sent at: " + newDate.today() + " " + newDate.timeNow();
            // Append each message in the array as a list item
            history.forEach((message, index) => {
                var status =  message[1] ? "SUCCESS" : "FAILED";
                const listItem = document.createElement("li");
                listItem.textContent = `[${datetime}] [${status}] message ${message[0]}`;
                messageList.appendChild(listItem);
            });
        }
    </script>
</head>
<body>
<h1>Server</h1>
<strong>Send history</strong>
<!--<div id="chat-log" readonly></div>-->
<ul id="messageList"></ul>
<input id="chat-message-input" type="text" size="80">
<button onclick="sendMessage()">Send</button>
</body>
</html>